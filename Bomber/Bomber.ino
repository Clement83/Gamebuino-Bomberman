#include <SPI.h>
#include <Gamebuino.h>
#include <math.h>
Gamebuino gb = Gamebuino();

boolean debug = false;
extern const byte font3x5[];



const byte logo[] PROGMEM = {
  64,30,
 B00000000,B00000000,B00000000,B00000000,B00000000,B00000000,B00000000,B00000000,
 B00000000,B00000000,B00000000,B00000000,B00000000,B00011000,B00000000,B00000000,
 B00000000,B00000000,B00000000,B00000000,B00000000,B01111110,B00000000,B00000000,
 B00000000,B00000000,B00000000,B00011111,B11100001,B11100010,B00000000,B00000000,
 B00000000,B00000000,B00000000,B01111111,B11111001,B11000011,B00000000,B00000000,
 B00000000,B00000000,B00000001,B11111111,B11111111,B10000011,B00000000,B00000000,
 B00000000,B00000000,B00000011,B11111111,B11111111,B10000000,B00000000,B00000000,
 B00000000,B00000000,B00000111,B11111111,B11111111,B10000000,B00000000,B00000000,

 B00000000,B00000000,B00001111,B11111111,B11111111,B11000000,B00000000,B00000000,
 B00000000,B00000000,B00001111,B11100000,B00111111,B11000000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100111,B10001111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100111,B11001111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100111,B11001111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100111,B11001111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100111,B10011111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100000,B00111111,B11110000,B00000000,B00000000,

 B00000000,B00000000,B00111111,B11100111,B10001111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100111,B11100111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100111,B11100111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00111111,B11100111,B11100111,B11110000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100111,B11000111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100111,B10001111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00011111,B11100000,B00111111,B11100000,B00000000,B00000000,
 B00000000,B00000000,B00001111,B11111111,B11111111,B11000000,B00000000,B00000000,

 B00000000,B00000000,B00001111,B11111111,B11111111,B11000000,B00000000,B00000000,
 B00000000,B00000000,B00000111,B11111111,B11111111,B10000000,B00000000,B00000000,
 B00000000,B00000000,B00000011,B11111111,B11111111,B00000000,B00000000,B00000000,
 B00000000,B00000000,B00000001,B11111111,B11111110,B00000000,B00000000,B00000000,
 B00000000,B00000000,B00000000,B01111111,B11111000,B00000000,B00000000,B00000000,
 B00000000,B00000000,B00000000,B00011111,B11100000,B00000000,B00000000,B00000000,
};

void setup () {
  Serial.begin(9600);
  Serial.println("Loading...");
  gb.begin();
  gb.pickRandomSeed();
  gb.setFrameRate(21);
  gb.battery.show = true; 
  gb.titleScreen(F("Bomberman by Limited"), logo);
  gb.display.setFont(font3x5);
}

void loop() {
   if (gb.update()) {  
    
    handleInput(); 
    
    if (debug) {
      debugRender();
      return;
    } 
    
    updateBomb();
    
    renderGame();
    renderPlayer();
    renderBomb();
  }  
}
extern byte playerx;
extern byte playery;
extern byte playerw;
extern byte playerh;
void debugRender() {
    if (!debug) return;
   
    gb.display.print("\nDebug Bomberman\n");
    gb.display.print("Player X:");
    gb.display.print(playerx);
    gb.display.print("\nPlayer Y:");
    gb.display.print(playery);
    
    gb.display.print("\nRAM Free:");
    gb.display.print(gb.getFreeRam());
    
    gb.display.print("\nCPU: ");
    gb.display.print(gb.getCpuLoad());
    
    gb.display.print("\nVersion: 1.0a");
}

void renderGame() {
  if (!debug)
     renderMap();
}
void handleInput() {
  if (gb.buttons.pressed(BTN_B)) 
    debug = !debug;
    
  if (gb.buttons.pressed(BTN_C))
     gb.titleScreen(F("Bomberman by Limited"), logo);
     
  if (gb.buttons.repeat(BTN_LEFT, 1))    
    playerLeft();
    
  else if (gb.buttons.repeat(BTN_RIGHT, 1))    
    playerRight();
    
  else if (gb.buttons.repeat(BTN_UP, 1))   
    playerUp();
      
  else if (gb.buttons.repeat(BTN_DOWN, 1))    
    playerDown();
    
  if(gb.buttons.pressed(BTN_A)) {
      setBomb(playerx+(playerw/2),playery+(playerh/2));
  }
}
